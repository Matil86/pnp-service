name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt
        run: ./gradlew detekt
        continue-on-error: true

      - name: Run ktlint
        run: ./gradlew ktlintCheck
        continue-on-error: true

      - name: Upload Detekt report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: detekt-report
          path: '**/build/reports/detekt/'

      - name: Upload ktlint report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ktlint-report
          path: '**/build/reports/ktlint/'

      - name: Annotate PR with Detekt findings
        uses: github/super-linter/slim@v5
        if: github.event_name == 'pull_request'
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_KOTLIN_DETEKT: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'pnp-service'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Upload Dependency Check report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-check-report
          path: 'reports/'

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Run tests
        run: ./gradlew test

      - name: Generate Jacoco report
        run: ./gradlew jacocoTestReport

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: '**/build/test-results/'

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: '**/build/reports/jacoco/test/jacocoTestReport.xml'
          fail_ci_if_error: false

  review-summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scan, build-and-test]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Comment PR with review summary
        uses: actions/github-script@v6
        with:
          script: |
            const staticAnalysis = '${{ needs.static-analysis.result }}';
            const securityScan = '${{ needs.security-scan.result }}';
            const buildTest = '${{ needs.build-and-test.result }}';

            const emoji = (result) => result === 'success' ? '‚úÖ' : result === 'failure' ? '‚ùå' : '‚ö†Ô∏è';

            const body = `## ü§ñ Automated Code Review Summary

            | Check | Status |
            |-------|--------|
            | Static Analysis (Detekt + ktlint) | ${emoji(staticAnalysis)} ${staticAnalysis} |
            | Security Scan (Trivy + OWASP) | ${emoji(securityScan)} ${securityScan} |
            | Build & Tests | ${emoji(buildTest)} ${buildTest} |

            ${buildTest === 'success' && staticAnalysis === 'success' && securityScan === 'success'
              ? '‚úÖ **All automated checks passed!** This PR is ready for human review.'
              : '‚ö†Ô∏è **Some checks failed.** Please review the details above and fix the issues.'}

            ---
            *Automated by GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
