name: Performance Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'genefunk/**'
      - 'data/**'
      - 'monolith/**'
  workflow_dispatch:  # Allow manual triggers

jobs:
  performance-benchmarks:
    name: Run Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Need history for comparison

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run JMH Benchmarks
        run: |
          echo "üèÉ Running performance benchmarks..."
          ./gradlew :genefunk:jmh --no-daemon
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: jmh-results
          path: '**/build/reports/jmh/'

      - name: Parse benchmark results
        id: parse
        run: |
          if [ -f genefunk/build/results/jmh/results.txt ]; then
            echo "Benchmark results found"
            cat genefunk/build/results/jmh/results.txt

            # Extract key metrics
            CHAR_GEN=$(grep "generateCharacterDefault" genefunk/build/results/jmh/results.txt | awk '{print $5}' || echo "N/A")
            echo "char_gen_time=$CHAR_GEN" >> $GITHUB_OUTPUT
          else
            echo "No benchmark results found"
            echo "char_gen_time=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Compare with baseline
        id: compare
        run: |
          # Performance thresholds (in milliseconds)
          CHAR_GEN_THRESHOLD=50
          BULK_GEN_THRESHOLD=3000

          # Get current results
          CURRENT_TIME="${{ steps.parse.outputs.char_gen_time }}"

          if [ "$CURRENT_TIME" != "N/A" ]; then
            # Check if within threshold
            if (( $(echo "$CURRENT_TIME < $CHAR_GEN_THRESHOLD" | bc -l) )); then
              echo "status=PASS" >> $GITHUB_OUTPUT
              echo "message=‚úÖ Performance within acceptable limits ($CURRENT_TIME ms < $CHAR_GEN_THRESHOLD ms)" >> $GITHUB_OUTPUT
            else
              echo "status=FAIL" >> $GITHUB_OUTPUT
              echo "message=‚ùå Performance degradation detected ($CURRENT_TIME ms > $CHAR_GEN_THRESHOLD ms)" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=UNKNOWN" >> $GITHUB_OUTPUT
            echo "message=‚ö†Ô∏è Could not determine performance metrics" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ steps.compare.outputs.status }}';
            const message = '${{ steps.compare.outputs.message }}';
            const charGenTime = '${{ steps.parse.outputs.char_gen_time }}';

            const emoji = status === 'PASS' ? '‚úÖ' : status === 'FAIL' ? '‚ùå' : '‚ö†Ô∏è';

            const body = `## ${emoji} Performance Benchmark Results

            ### Character Generation Performance
            - **Average Time**: ${charGenTime} ms
            - **Threshold**: 50 ms
            - **Status**: ${status}

            ${message}

            ### Performance Requirements
            | Operation | Threshold | Status |
            |-----------|-----------|--------|
            | Single Character Generation | < 50ms | ${status === 'PASS' ? '‚úÖ' : '‚ùå'} |
            | Bulk Generation (100 chars) | < 3s | ‚è≥ Pending |

            ${status === 'FAIL' ? `
            ### ‚ö†Ô∏è Performance Regression Detected

            This PR introduces a performance regression. Please review:
            1. Are there unnecessary database queries?
            2. Are collections being processed efficiently?
            3. Are there any blocking operations in hot paths?
            4. Have you profiled the code to identify bottlenecks?

            Consider:
            - Adding indexes to database queries
            - Using bulk operations instead of loops
            - Caching frequently accessed data
            - Optimizing algorithm complexity
            ` : ''}

            <details>
            <summary>üìä Full Benchmark Report</summary>

            See attached artifacts for complete JMH results.

            </details>

            ---
            *Performance benchmarks run automatically on all PRs*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if performance degraded
        if: steps.compare.outputs.status == 'FAIL'
        run: |
          echo "‚ùå Performance gate failed"
          echo "${{ steps.compare.outputs.message }}"
          exit 1

  load-testing:
    name: Load Testing (Optional)
    runs-on: ubuntu-latest
    if: github.event.pull_request.labels.*.name contains 'performance-critical'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build application
        run: ./gradlew build -x test

      - name: Start application
        run: |
          ./gradlew :monolith:bootRun &
          echo $! > app.pid
          sleep 30  # Wait for app to start

      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load tests
        run: |
          cat > load-test.js <<'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            vus: 10,
            duration: '30s',
            thresholds: {
              http_req_duration: ['p(95)<500'], // 95% of requests under 500ms
            },
          };

          export default function () {
            const res = http.get('http://localhost:8080/api/characters');
            check(res, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });
            sleep(1);
          }
          EOF

          k6 run load-test.js

      - name: Stop application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi
